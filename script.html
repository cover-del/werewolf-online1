<script>
let state={roomId:null,playerId:null,name:null,isHost:false};

const nameEl=document.getElementById('name');
const avatarFileEl=document.getElementById('avatarFile');
const createBtn=document.getElementById('createBtn');
const joinBtn=document.getElementById('joinBtn');
const roomInput=document.getElementById('roomInput');

const roomPanel=document.getElementById('roomPanel');
const roomLabel=document.getElementById('roomLabel');
const playersWrap=document.getElementById('players');
const chatBox=document.getElementById('chatBox');
const chatInput=document.getElementById('chatInput');
const sendChatBtn=document.getElementById('sendChatBtn');
const assignBtn=document.getElementById('assignBtn');
const leaveBtn=document.getElementById('leaveBtn');
const gameStateEl=document.getElementById('gameState');
const actionArea=document.getElementById('actionArea');

async function _readAvatar(){return new Promise(r=>{const f=avatarFileEl.files[0];if(!f) return r(''); const fr=new FileReader();fr.onload=()=>r(fr.result);fr.readAsDataURL(f);});}

createBtn.onclick=async ()=>{
  const name=nameEl.value||'玩家'; const avatar=await _readAvatar();
  google.script.run.withSuccessHandler(res=>{
    state.roomId=res.roomId; state.playerId=res.playerId; state.name=name; state.isHost=true;
    _enterRoomUI(); _startPolling();
  }).createRoom(name,avatar);
};

joinBtn.onclick=async ()=>{
  const rid=roomInput.value||''; if(!rid)return alert('請輸入房間ID'); 
  const name=nameEl.value||'玩家'; const avatar=await _readAvatar();
  google.script.run.withSuccessHandler(res=>{
    state.roomId=rid; state.playerId=res.playerId; state.name=name; state.isHost=false;
    _enterRoomUI(); _startPolling();
  }).joinRoom(rid,name,avatar);
};

sendChatBtn.onclick=()=>{ const txt=chatInput.value||''; if(!txt)return; google.script.run.postChat(state.roomId,state.playerId,txt); chatInput.value=''; };
assignBtn.onclick=()=>{ if(!state.isHost)return; google.script.run.assignRoles(state.roomId,state.playerId); };
leaveBtn.onclick=()=>{ google.script.run.withSuccessHandler(()=>location.reload()).leaveRoom(state.roomId,state.playerId); };

function _enterRoomUI(){document.getElementById('lobby').style.display='none';roomPanel.style.display='';roomLabel.textContent=state.roomId;}

let pollHandle=null;
function _startPolling(){ if(pollHandle)return; _pollOnce(); pollHandle=setInterval(_pollOnce,1500);}
function _pollOnce(){ if(!state.roomId)return; google.script.run.withSuccessHandler(_renderRoom).getRoomState(state.roomId,state.playerId);}
function _renderRoom(room){ if(!room)return; playersWrap.innerHTML=''; Object.values(room.players||{}).forEach(p=>{ const div=document.createElement('div'); div.className='player'; div.innerHTML=`<img class="avatar" src="${p.avatar||'https://via.placeholder.com/64?text=?'}"><div>${p.name}</div><div>${p.alive?'':'已出局'}</div><div>角色: ${p.role||'?'}</div>`; playersWrap.appendChild(div); }); chatBox.innerHTML=''; (room.chat||[]).forEach(m=>{ const el=document.createElement('div'); el.innerHTML=`${m.system?'<i>':'<b>'+m.name+':'}</b> ${m.text}`; chatBox.appendChild(el); }); gameStateEl.textContent=`Phase: ${room.phase} • Round: ${room.round||0}`;
}
</script>
